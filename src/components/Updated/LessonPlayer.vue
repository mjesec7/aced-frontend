<template>
  <div class="lesson-player-overlay" @click="handleOverlayClick">
    <div class="lesson-player" @click.stop>
      <header class="player-header">
        <button 
          class="close-btn" 
          @click="$emit('close')" 
          aria-label="–ó–∞–∫—Ä—ã—Ç—å —É—Ä–æ–∫"
          title="–ó–∞–∫—Ä—ã—Ç—å —É—Ä–æ–∫"
        >
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>

        <div class="header-content">
          <div class="course-info">
            <span class="course-name">{{ courseTitle }}</span>
            <h1 class="lesson-title">{{ currentLessonTitle }}</h1>
          </div>

          <div class="progress-section">
            <div class="progress-bar">
              <div 
                class="progress-fill" 
                :style="{ width: progressPercentage }"
              ></div>
            </div>
            <span class="progress-text">
              –£—Ä–æ–∫ {{ currentLessonIndex + 1 }} –∏–∑ {{ totalLessons }}
            </span>
          </div>
        </div>
      </header>

      <main class="player-content">
        <div v-if="loading" class="loading-state">
          <div class="spinner"></div>
          <h3>–ó–∞–≥—Ä—É–∑–∫–∞ –∫—É—Ä—Å–∞...</h3>
          <p>–ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è</p>
        </div>

        <div v-else-if="error" class="error-state">
          <div class="error-icon">‚ö†Ô∏è</div>
          <h3>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—É—Ä—Å</h3>
          <p>{{ error }}</p>
          <button @click="loadCourseContent" class="retry-btn">
            –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
          </button>
        </div>

        <div v-else-if="currentLesson && hasSteps" class="lesson-content">
          <div 
            v-for="(step, index) in currentLesson.steps" 
            :key="`step-${index}`"
            class="step-container"
          >
            <div class="step-header">
              <div class="step-number">{{ index + 1 }}</div>
              <h2 class="step-title">{{ getStepTitle(step) }}</h2>
            </div>

            <div class="step-body">
              <component 
                :is="getStepComponent(step.type)"
                :step="step"
                :step-index="index"
                @quiz-answer="handleQuizAnswer"
                @pdf-fullscreen="openPdfFullscreen"
              />
            </div>
          </div>
        </div>

        <div v-else-if="currentLesson && !hasSteps" class="empty-lesson">
          <div class="empty-icon">üìù</div>
          <h3>–£—Ä–æ–∫ –ø—É—Å—Ç</h3>
          <p>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —É—Ä–æ–∫–∞ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ</p>
        </div>

        <div v-else class="no-content">
          <div class="empty-icon">üìö</div>
          <h3>–ö—É—Ä—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</h3>
          <p>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –∫—É—Ä—Å–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –∏–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</p>
          <button @click="$emit('back-to-courses')" class="back-btn">
            –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫—É—Ä—Å–∞–º
          </button>
        </div>
      </main>

      <footer class="player-footer" v-if="!loading && !error && lessons.length > 0">
        <button 
          class="nav-btn nav-btn--secondary"
          :disabled="isFirstLesson"
          @click="goToPreviousLesson"
        >
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15,18 9,12 15,6"></polyline>
          </svg>
          –ü—Ä–µ–¥—ã–¥—É—â–∏–π
        </button>

        <div class="lesson-counter">
          <span class="current-lesson">{{ currentLessonIndex + 1 }}</span>
          <span class="divider">/</span>
          <span class="total-lessons">{{ totalLessons }}</span>
        </div>

        <button 
          v-if="!isLastLesson"
          class="nav-btn nav-btn--primary"
          @click="goToNextLesson"
        >
          –°–ª–µ–¥—É—é—â–∏–π
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9,18 15,12 9,6"></polyline>
          </svg>
        </button>

        <button 
          v-else
          class="nav-btn nav-btn--success"
          @click="completeCourse"
        >
          –ó–∞–≤–µ—Ä—à–∏—Ç—å –∫—É—Ä—Å
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20,6 9,17 4,12"></polyline>
          </svg>
        </button>
      </footer>
    </div>

    <div v-if="fullscreenPdf" class="pdf-modal" @click="closePdfFullscreen">
      <div class="pdf-container" @click.stop>
        <button 
          class="pdf-close-btn"
          @click="closePdfFullscreen"
          aria-label="–ó–∞–∫—Ä—ã—Ç—å PDF"
        >
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
        <iframe 
          :src="fullscreenPdf" 
          class="pdf-frame"
          title="PDF Viewer"
        ></iframe>
      </div>
    </div>
  </div>
</template>

<script>
// ‚úÖ MAIN FRONTEND API IMPORTS - Uses your backend endpoints
import { getCourseById, getCourseContent } from '@/api.js';

export default {
  name: 'LessonPlayer',
  
  props: {
    course: {
      type: Object,
      required: true,
      validator: (course) => course && (course.title || course._id)
    }
  },

  emits: ['close', 'back-to-courses'],

  data() {
    return {
      lessons: [],
      currentLessonIndex: 0,
      quizAnswers: new Map(),
      fullscreenPdf: null,
      loading: true,
      error: null,
      courseData: null
    }
  },

  computed: {
    courseTitle() {
      return this.courseData?.title || this.course?.title || '–ö—É—Ä—Å';
    },

    currentLesson() {
      return this.lessons[this.currentLessonIndex] || null;
    },

    currentLessonTitle() {
      const lesson = this.currentLesson;
      if (!lesson) return '–ó–∞–≥—Ä—É–∑–∫–∞ —É—Ä–æ–∫–∞...';
      return lesson.title || lesson.lessonName || `–£—Ä–æ–∫ ${this.currentLessonIndex + 1}`;
    },

    hasSteps() {
      return this.currentLesson && this.currentLesson.steps && this.currentLesson.steps.length > 0;
    },

    totalLessons() {
      return this.lessons.length;
    },

    progressPercentage() {
      if (this.totalLessons === 0) return '0%';
      return `${Math.round(((this.currentLessonIndex + 1) / this.totalLessons) * 100)}%`;
    },

    isFirstLesson() {
      return this.currentLessonIndex === 0;
    },

    isLastLesson() {
      return this.currentLessonIndex === this.totalLessons - 1;
    }
  },

  watch: {
    course: {
      handler() {
        this.loadCourseContent();
      },
      deep: true,
      immediate: true
    }
  },

  methods: {
    // ‚úÖ REAL API CALLS: Load course content from backend
    async loadCourseContent() {
      if (!this.course || (!this.course._id && !this.course.id)) {
        console.error('‚ùå LessonPlayer: Invalid course data:', this.course);
        this.error = '–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫—É—Ä—Å–∞';
        this.loading = false;
        return;
      }

      this.loading = true;
      this.error = null;

      try {
        const courseId = this.course._id || this.course.id;
        console.log('üìö LessonPlayer: Loading course content for ID:', courseId);

        let courseDetails = null;
        let lessons = [];

        // Step 1: Try to get complete course details from backend
        try {
          console.log('üîç Step 1: Fetching course details from API...');
          const courseResponse = await getCourseById(courseId);
          
          if (courseResponse && courseResponse.success && courseResponse.data) {
            courseDetails = courseResponse.data;
            console.log('‚úÖ Course details loaded from API:', courseDetails.title);
            
            // Check if course has curriculum in the response
            if (courseDetails.curriculum && Array.isArray(courseDetails.curriculum)) {
              lessons = this.processLessons(courseDetails.curriculum);
              console.log('‚úÖ Lessons extracted from API course curriculum:', lessons.length);
            }
          } else {
            console.warn('‚ö†Ô∏è Course details API returned invalid response:', courseResponse);
          }
        } catch (detailError) {
          console.warn('‚ö†Ô∏è LessonPlayer: Failed to load course details from API:', detailError.message);
        }

        // Step 2: If no lessons from course details, try course content endpoint
        if (lessons.length === 0) {
          try {
            console.log('üîç Step 2: Fetching course content from API...');
            const contentResponse = await getCourseContent(courseId);
            
            if (contentResponse && contentResponse.success && contentResponse.data) {
              lessons = this.processLessons(contentResponse.data);
              console.log('‚úÖ Lessons loaded from API content endpoint:', lessons.length);
            } else {
              console.warn('‚ö†Ô∏è Course content API returned invalid response:', contentResponse);
            }
          } catch (contentError) {
            console.warn('‚ö†Ô∏è LessonPlayer: getCourseContent API failed:', contentError.message);
          }
        }

        // Step 3: If still no lessons, try from the original course prop
        if (lessons.length === 0 && this.course.curriculum) {
          console.log('üîç Step 3: Using course prop curriculum (fallback)...');
          lessons = this.processLessons(this.course.curriculum);
          console.log('‚úÖ Lessons extracted from course prop:', lessons.length);
        }

        // Step 4: Final fallback - create demo content ONLY if no real content available
        if (lessons.length === 0) {
          console.log('üîç Step 4: No real content found, creating demo lessons...');
          lessons = this.createDemoLessons();
          this.error = '–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ - —Ä–µ–∞–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∫—É—Ä—Å–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã';
        }

        // Set course data and lessons
        this.courseData = courseDetails || this.course;
        this.lessons = lessons;

        console.log(`‚úÖ LessonPlayer: Successfully loaded ${lessons.length} lessons for course: ${this.courseData?.title}`);
        
        if (lessons.length > 0 && !this.error) {
          this.error = null;
        }
        
      } catch (error) {
        console.error('‚ùå LessonPlayer: Critical error loading course content:', error);
        
        if (error.message && error.message.includes('Network Error')) {
          this.error = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É';
        } else if (error.response?.status === 404) {
          this.error = '–ö—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ';
        } else if (error.response?.status === 403) {
          this.error = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫—É—Ä—Å—É';
        } else if (error.response?.status >= 500) {
          this.error = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ - –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ';
        } else {
          this.error = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∫—É—Ä—Å–∞';
        }
        
        try {
          this.lessons = this.createDemoLessons();
          this.error += ' (–ø–æ–∫–∞–∑–∞–Ω–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ)';
        } catch (demoError) {
          console.error('‚ùå Even demo content failed:', demoError);
          this.error = '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è –∫—É—Ä—Å–∞';
        }
      } finally {
        this.loading = false;
      }
    },

    // ‚úÖ FIXED: Process lessons with better content extraction
    processLessons(lessonsArray) {
      if (!Array.isArray(lessonsArray)) {
        console.warn('‚ö†Ô∏è processLessons: Input is not an array:', typeof lessonsArray);
        return [];
      }

      const processedLessons = [];

      lessonsArray.forEach((lesson, index) => {
        try {
          if (!lesson || typeof lesson !== 'object') {
            console.warn(`‚ö†Ô∏è Invalid lesson at index ${index}:`, lesson);
            return;
          }

          const processedLesson = {
            ...lesson,
            id: lesson._id || lesson.id || `lesson_${index}`,
            _id: lesson._id || lesson.id || `lesson_${index}`,
            title: lesson.title || lesson.lessonName || lesson.name || `–£—Ä–æ–∫ ${index + 1}`,
            lessonName: lesson.title || lesson.lessonName || lesson.name || `–£—Ä–æ–∫ ${index + 1}`,
            description: lesson.description || lesson.desc || '',
            duration: lesson.duration || lesson.estimatedTime || '30 –º–∏–Ω',
            order: lesson.order !== undefined ? lesson.order : index,
            steps: this.processSteps(lesson.steps || lesson.content || [])
          };

          processedLessons.push(processedLesson);
          console.log(`‚úÖ Processed lesson ${index + 1}: "${processedLesson.title}" with ${processedLesson.steps.length} steps`);

        } catch (lessonError) {
          console.error(`‚ùå Error processing lesson ${index}:`, lessonError);
          
          processedLessons.push({
            id: `fallback_lesson_${index}`,
            _id: `fallback_lesson_${index}`,
            title: `–£—Ä–æ–∫ ${index + 1} (–æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏)`,
            lessonName: `–£—Ä–æ–∫ ${index + 1} (–æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏)`,
            description: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —É—Ä–æ–∫–∞',
            steps: []
          });
        }
      });

      return processedLessons;
    },

    // ‚úÖ COMPLETELY FIXED: Process steps with comprehensive content handling
    processSteps(steps) {
      if (!Array.isArray(steps)) {
        console.warn('‚ö†Ô∏è processSteps: Input is not an array:', typeof steps);
        return [];
      }

      const processedSteps = [];

      steps.forEach((step, index) => {
        try {
          if (!step || typeof step !== 'object') {
            console.warn(`‚ö†Ô∏è Invalid step at index ${index}:`, step);
            return;
          }

          // ‚úÖ CRITICAL FIX: Better step type detection
          const stepType = this.detectStepType(step);
          
          const processedStep = {
            ...step,
            id: step.id || step._id || `step_${index}`,
            type: stepType,
            title: step.title || step.name || this.getStepTitle({ ...step, type: stepType }),
            description: step.description || step.desc || '',
            content: this.extractContent(step), // ‚úÖ NEW: Extract content properly
            data: this.processStepData(step, stepType), // ‚úÖ FIXED: Pass stepType
            order: step.order !== undefined ? step.order : index
          };

          processedSteps.push(processedStep);
          console.log(`‚úÖ Processed step ${index + 1}: "${processedStep.title}" (${stepType}) - Content length: ${processedStep.content?.length || 0}`);
          
        } catch (stepError) {
          console.error(`‚ùå Error processing step ${index}:`, stepError);
          
          processedSteps.push({
            id: `fallback_step_${index}`,
            type: 'explanation',
            title: '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏',
            description: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —à–∞–≥–∞',
            content: '–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —à–∞–≥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ',
            data: { content: '–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —à–∞–≥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ' }
          });
        }
      });

      return processedSteps;
    },

    // ‚úÖ NEW: Detect step type more accurately
    detectStepType(step) {
      if (!step) return 'explanation';

      // Direct type property
      if (step.type) {
        return step.type.toLowerCase();
      }

      // Check for specific properties that indicate type
      if (step.question || step.quiz || step.quizzes || (step.data && Array.isArray(step.data))) {
        return 'quiz';
      }

      if (step.videoUrl || step.video || (step.data && step.data.url && step.data.url.includes('youtube'))) {
        return 'video';
      }

      if (step.pdfUrl || step.pdf || (step.data && step.data.url && step.data.url.includes('.pdf'))) {
        return 'pdf';
      }

      if (step.practice || step.practiceType || step.instructions || step.files) {
        return 'practice';
      }

      if (step.images && Array.isArray(step.images) && step.images.length > 0 && !step.content && !step.text) {
        return 'image';
      }

      // Check content for indicators
      const content = step.content || step.text || step.description || '';
      if (typeof content === 'string') {
        if (content.includes('example:') || content.includes('–ø—Ä–∏–º–µ—Ä:')) {
          return 'example';
        }
        if (content.includes('read:') || content.includes('—á–∏—Ç–∞—Ç—å:')) {
          return 'reading';
        }
      }

      // Default to explanation
      return 'explanation';
    },

    // ‚úÖ NEW: Extract content from various possible locations
    extractContent(step) {
      if (!step) return '';

      // Priority order for content extraction
      const contentSources = [
        step.content,
        step.text,
        step.description,
        step.body,
        step.html,
        step.markdown,
        step.data?.content,
        step.data?.text,
        step.data?.description,
        step.data?.body
      ];

      for (const source of contentSources) {
        if (source && typeof source === 'string' && source.trim().length > 0) {
          console.log('üìù Found content:', source.substring(0, 100) + '...');
          return source.trim();
        }
      }

      // If no text content found, create descriptive content based on type
      return this.generateFallbackContent(step);
    },

    // ‚úÖ NEW: Generate fallback content when no text is found
    generateFallbackContent(step) {
      const stepType = this.detectStepType(step);
      
      switch (stepType) {
        case 'video':
          const videoUrl = step.videoUrl || step.video || step.data?.url || '';
          return videoUrl ? `–í–∏–¥–µ–æ–º–∞—Ç–µ—Ä–∏–∞–ª: ${videoUrl}` : '–í–∏–¥–µ–æ–º–∞—Ç–µ—Ä–∏–∞–ª';
          
        case 'pdf':
          const pdfUrl = step.pdfUrl || step.pdf || step.data?.url || '';
          return pdfUrl ? `PDF –¥–æ–∫—É–º–µ–Ω—Ç: ${pdfUrl}` : 'PDF –¥–æ–∫—É–º–µ–Ω—Ç';
          
        case 'practice':
          const instructions = step.instructions || step.data?.instructions || '';
          return instructions || '–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ';
          
        case 'quiz':
          const question = step.question || step.data?.question || step.data?.[0]?.question || '';
          return question || '–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ—Å—Ç';
          
        case 'image':
          const images = step.images || step.data?.images || [];
          return images.length > 0 ? `–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (${images.length})` : '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
          
        default:
          return step.title || step.name || '–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —à–∞–≥–∞';
      }
    },

    // ‚úÖ COMPLETELY FIXED: Process step data with proper type-specific handling
    processStepData(step, stepType) {
      if (!step || typeof step !== 'object') {
        return { content: '', error: 'Invalid step data' };
      }

      const baseData = step.data || {};
      const type = stepType || step.type || 'explanation';

      try {
        switch (type) {
          case 'explanation':
          case 'example':  
          case 'reading':
          case 'text':
            return {
              ...baseData,
              content: this.extractContent(step),
              images: this.processImages(baseData.images || step.images || [])
            };

          case 'image':
            return {
              ...baseData,
              images: this.processImages(baseData.images || step.images || []),
              description: baseData.description || step.description || this.extractContent(step),
              caption: baseData.caption || step.caption || ''
            };

          case 'video':
            return {
              ...baseData,
              url: baseData.url || step.videoUrl || step.video || step.url || '',
              description: baseData.description || step.description || this.extractContent(step),
              thumbnail: baseData.thumbnail || step.thumbnail
            };

          case 'pdf':
            return {
              ...baseData,
              url: baseData.url || step.pdfUrl || step.pdf || step.url || '',
              description: baseData.description || step.description || this.extractContent(step)
            };

          case 'practice':
            return {
              ...baseData,
              instructions: baseData.instructions || step.instructions || this.extractContent(step),
              type: baseData.type || step.practiceType || 'guided',
              files: baseData.files || step.files || [],
              images: this.processImages(baseData.images || step.images || [])
            };

          case 'quiz':
            return this.processQuizData(step, baseData);

          default:
            console.warn(`‚ö†Ô∏è Unknown step type: ${type}`);
            return {
              ...baseData,
              content: this.extractContent(step),
              images: this.processImages(baseData.images || step.images || [])
            };
        }
      } catch (dataError) {
        console.error(`‚ùå Error processing step data for type ${type}:`, dataError);
        return {
          content: this.extractContent(step) || '–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö —à–∞–≥–∞',
          error: dataError.message
        };
      }
    },

    // ‚úÖ NEW: Better quiz data processing
    processQuizData(step, baseData) {
      // Handle multiple quiz data formats
      if (Array.isArray(baseData) && baseData.length > 0) {
        return baseData.map(quiz => ({
          ...quiz,
          question: quiz.question || quiz.text || '',
          images: this.processImages(quiz.images || [])
        }));
      } 
      
      if (Array.isArray(baseData.questions)) {
        return baseData.questions.map(quiz => ({
          ...quiz,
          question: quiz.question || quiz.text || '',
          images: this.processImages(quiz.images || [])
        }));
      } 
      
      if (step.question || baseData.question) {
        return [{
          question: step.question || baseData.question || this.extractContent(step),
          type: step.quizType || baseData.type || 'multiple-choice',
          options: this.processQuizOptions(step.options || baseData.options || []),
          correctAnswer: parseInt(step.correctAnswer || baseData.correctAnswer) || 0,
          explanation: step.explanation || baseData.explanation || '',
          images: this.processImages(step.questionImages || step.images || [])
        }];
      } 
      
      if (step.quizzes && Array.isArray(step.quizzes)) {
        return step.quizzes.map(quiz => ({
          ...quiz,
          question: quiz.question || quiz.text || '',
          images: this.processImages(quiz.images || [])
        }));
      }
      
      if (Array.isArray(step.data)) {
        return step.data.map(quiz => ({
          ...quiz,
          question: quiz.question || quiz.text || '',
          images: this.processImages(quiz.images || [])
        }));
      }

      return [];
    },

    // ‚úÖ NEW: Process quiz options properly
    processQuizOptions(options) {
      if (!Array.isArray(options)) return [];
      
      return options.map(opt => {
        if (typeof opt === 'string') {
          return { text: opt, correct: false };
        }
        if (typeof opt === 'object' && opt !== null) {
          return {
            text: opt.text || opt.label || opt.value || String(opt),
            correct: Boolean(opt.correct || opt.isCorrect)
          };
        }
        return { text: String(opt), correct: false };
      });
    },

    // ‚úÖ ENHANCED: Process images with better URL handling
    processImages(images) {
      if (!Array.isArray(images)) return [];

      return images
        .filter(img => img && (img.url || img.base64 || img.src))
        .map((img, index) => {
          try {
            let imageUrl = img.url || img.src || img.base64;
            
            if (imageUrl) {
              // Handle base64 images
              if (imageUrl.startsWith('data:')) {
                // Base64 is ready to use
              } 
              // Handle relative URLs
              else if (imageUrl.startsWith('/uploads/')) {
                const baseUrl = process.env.NODE_ENV === 'production' 
                  ? 'https://api.aced.live'
                  : 'http://localhost:5000';
                imageUrl = `${baseUrl}${imageUrl}`;
              }
              // Handle other relative URLs
              else if (imageUrl.startsWith('/') && !imageUrl.startsWith('//')) {
                const baseUrl = process.env.NODE_ENV === 'production' 
                  ? 'https://api.aced.live'
                  : 'http://localhost:5000';
                imageUrl = `${baseUrl}${imageUrl}`;
              }
              // Absolute URLs are used as-is
            }

            return {
              id: img.id || `img_${index}_${Date.now()}`,
              url: imageUrl,
              caption: img.caption || img.description || img.alt || '',
              alt: img.alt || img.caption || img.description || `–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ${index + 1}`,
              filename: img.filename || img.name || `image_${index}`,
              size: img.size || 0,
              order: img.order !== undefined ? img.order : index
            };
          } catch (imgError) {
            console.error(`‚ùå Error processing image ${index}:`, imgError);
            return null;
          }
        })
        .filter(img => img !== null)
        .sort((a, b) => (a.order || 0) - (b.order || 0));
    },

    // ‚úÖ ENHANCED: Create demo lessons with rich content
    createDemoLessons() {
      const courseTitle = this.courseData?.title || this.course?.title || '–ö—É—Ä—Å';
      
      return [
        {
          id: 'demo_lesson_1',
          _id: 'demo_lesson_1',
          title: '–í–≤–µ–¥–µ–Ω–∏–µ –≤ –∫—É—Ä—Å',
          lessonName: '–í–≤–µ–¥–µ–Ω–∏–µ –≤ –∫—É—Ä—Å',
          description: '–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ - —Ä–µ–∞–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã',
          duration: '15 –º–∏–Ω',
          steps: [
            {
              id: 'demo_step_1_1',
              type: 'explanation',
              title: '‚ö†Ô∏è –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ',
              content: `–≠—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∫—É—Ä—Å–∞ "${courseTitle}".
              
              –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤:
              ‚Ä¢ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –∫—É—Ä—Å–∞ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
              ‚Ä¢ –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç–µ–≤—ã–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ API
              ‚Ä¢ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–µ–ø–æ–ª–∞–¥–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
              ‚Ä¢ –ö—É—Ä—Å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
              
              –ß—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:
              ‚Ä¢ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â–µ —Ä–∞–∑
              ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É
              ‚Ä¢ –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å–∏—Å—Ç–µ–º—ã
              ‚Ä¢ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ`,
              data: {
                content: `–≠—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∫—É—Ä—Å–∞ "${courseTitle}".
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #ffc107;">
                  <strong>‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ:</strong> –†–µ–∞–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∫—É—Ä—Å–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.
                </div>
                
                <h3>–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</h3>
                <ul>
                  <li>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –∫—É—Ä—Å–∞ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä</li>
                  <li>–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç–µ–≤—ã–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ API</li>
                  <li>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–µ–ø–æ–ª–∞–¥–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ</li>
                  <li>–ö—É—Ä—Å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏</li>
                </ul>
                
                <h3>–ß—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:</h3>
                <ul>
                  <li>–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â–µ —Ä–∞–∑</li>
                  <li>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É</li>
                  <li>–û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å–∏—Å—Ç–µ–º—ã</li>
                  <li>–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ</li>
                </ul>`
              }
            },
            {
              id: 'demo_step_1_2',
              type: 'explanation',
              title: '–ö–∞–∫ –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –∫—É—Ä—Å',
              content: `–ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∫—É—Ä—Å –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
              
              ‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É—Ä–æ–∫–∏ —Å —Ç–µ–æ—Ä–∏–µ–π –∏ –ø—Ä–∞–∫—Ç–∏–∫–æ–π
              ‚Ä¢ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏ —Ç–µ—Å—Ç—ã  
              ‚Ä¢ –í–∏–¥–µ–æ–º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
              ‚Ä¢ –°–∏—Å—Ç–µ–º—É –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
              ‚Ä¢ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è —Å —Ñ–∞–π–ª–∞–º–∏
              ‚Ä¢ –ò—Ç–æ–≥–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–µ —Ä–∞–±–æ—Ç—ã`,
              data: {
                content: `<h3>–ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∫—É—Ä—Å –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å:</h3>
                
                <ul>
                  <li><strong>–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É—Ä–æ–∫–∏</strong> —Å —Ç–µ–æ—Ä–∏–µ–π –∏ –ø—Ä–∞–∫—Ç–∏–∫–æ–π</li>
                  <li><strong>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</strong> –∏ —Ç–µ—Å—Ç—ã</li>
                  <li><strong>–í–∏–¥–µ–æ–º–∞—Ç–µ—Ä–∏–∞–ª—ã</strong> –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã</li>
                  <li><strong>–°–∏—Å—Ç–µ–º—É –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</strong></li>
                  <li><strong>–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è</strong> —Å —Ñ–∞–π–ª–∞–º–∏</li>
                  <li><strong>–ò—Ç–æ–≥–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</strong></li>
                </ul>
                
                <p>–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–ª–µ–µ—Ä–∞ —É–∂–µ –≥–æ—Ç–æ–≤—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞!</p>`
              }
            }
          ]
        },
        {
          id: 'demo_lesson_2',
          _id: 'demo_lesson_2',
          title: '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π –ø–ª–µ–µ—Ä–∞',
          lessonName: '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π –ø–ª–µ–µ—Ä–∞',
          description: '–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π —Å–∏—Å—Ç–µ–º—ã',
          duration: '10 –º–∏–Ω',
          steps: [
            {
              id: 'demo_step_2_1',
              type: 'explanation',
              title: '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞',
              content: `–≠—Ç–æ—Ç –ø–ª–µ–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞:
              
              ‚Ä¢ –¢–µ–∫—Å—Ç–æ–≤—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã (–∫–∞–∫ —ç—Ç–æ—Ç)
              ‚Ä¢ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –≤—ã–±–æ—Ä–æ–º
              ‚Ä¢ –í–∏–¥–µ–æ–º–∞—Ç–µ—Ä–∏–∞–ª—ã (YouTube, –ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏)
              ‚Ä¢ PDF –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
              ‚Ä¢ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è —Å –∑–∞–≥—Ä—É–∂–∞–µ–º—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏
              ‚Ä¢ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –ø–æ–¥–ø–∏—Å—è–º–∏ –∏ –æ–ø–∏—Å–∞–Ω–∏—è–º–∏
              
              –í—Å–µ —Ç–∏–ø—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω –∏ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö.`,
              data: {
                content: `<h3>–≠—Ç–æ—Ç –ø–ª–µ–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞:</h3>
                
                <ul>
                  <li>üìù <strong>–¢–µ–∫—Å—Ç–æ–≤—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è</strong> –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã (–∫–∞–∫ —ç—Ç–æ—Ç)</li>
                  <li>‚ùì <strong>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã</strong> —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –≤—ã–±–æ—Ä–æ–º</li>
                  <li>üé• <strong>–í–∏–¥–µ–æ–º–∞—Ç–µ—Ä–∏–∞–ª—ã</strong> (YouTube, –ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏)</li>
                  <li>üìÑ <strong>PDF –¥–æ–∫—É–º–µ–Ω—Ç—ã</strong> —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</li>
                  <li>üéØ <strong>–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è</strong> —Å –∑–∞–≥—Ä—É–∂–∞–µ–º—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏</li>
                  <li>üñºÔ∏è <strong>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</strong> —Å –ø–æ–¥–ø–∏—Å—è–º–∏ –∏ –æ–ø–∏—Å–∞–Ω–∏—è–º–∏</li>
                </ul>
                
                <div style="background: #e0f2fe; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #0277bd;">
                  <strong>üí° –í–∞–∂–Ω–æ:</strong> –í—Å–µ —Ç–∏–ø—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω –∏ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö.
                </div>`
              }
            },
            {
              id: 'demo_step_2_2',
              type: 'quiz',
              title: '–ü—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞',
              content: '–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è',
              data: [{
                question: '–≠—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∫—É—Ä—Å–∞?',
                type: 'multiple-choice',
                options: [
                  { text: '–î–∞, —ç—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π', correct: true },
                  { text: '–ù–µ—Ç, —ç—Ç–æ —Ä–µ–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∫—É—Ä—Å', correct: false },
                  { text: '–ù–µ –∑–Ω–∞—é, –Ω–µ –º–æ–≥—É –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å', correct: false },
                  { text: '–≠—Ç–æ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–∏—Å—Ç–µ–º—ã', correct: false }
                ],
                correctAnswer: 0,
                explanation: '–í–µ—Ä–Ω–æ! –≠—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∫—É—Ä—Å–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –û–Ω–æ –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–Ω—è—Ç—å, –∫–∞–∫ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –∏ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞—Å—Ç–æ—è—â–∏–π –∫—É—Ä—Å.'
              }]
            }
          ]
        }
      ];
    },
    
    // === Navigation Methods ===
    goToPreviousLesson() {
      if (!this.isFirstLesson) {
        this.currentLessonIndex--;
        console.log(`üîô Previous lesson: ${this.currentLessonIndex + 1}`);
      }
    },

    goToNextLesson() {
      if (!this.isLastLesson) {
        this.currentLessonIndex++;
        console.log(`‚û°Ô∏è Next lesson: ${this.currentLessonIndex + 1}`);
      }
    },

    completeCourse() {
      console.log('üéâ Course completed!');
      if (confirm('–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º –∫—É—Ä—Å–∞! –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É –∫—É—Ä—Å–æ–≤?')) {
        this.$emit('back-to-courses');
      }
    },

    // === Event Handlers ===
    handleOverlayClick() {
      this.$emit('close');
    },

    handleQuizAnswer(stepIndex, answerIndex, isCorrect) {
      this.quizAnswers.set(stepIndex, {
        answerIndex,
        isCorrect,
        answered: true
      });
      console.log('üìù Quiz answer recorded:', { stepIndex, answerIndex, isCorrect });
    },

    openPdfFullscreen(pdfUrl) {
      this.fullscreenPdf = pdfUrl;
    },

    closePdfFullscreen() {
      this.fullscreenPdf = null;
    },

    // === Utility Methods ===
    getStepTitle(step) {
      if (step.title) return step.title;
      const titles = {
        explanation: 'üìù –û–±—ä—è—Å–Ω–µ–Ω–∏–µ', 
        example: 'üí° –ü—Ä–∏–º–µ—Ä', 
        text: 'üìù –¢–µ–∫—Å—Ç',
        reading: 'üìö –ß—Ç–µ–Ω–∏–µ',
        video: 'üé• –í–∏–¥–µ–æ',
        pdf: 'üìÑ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã', 
        practice: 'üéØ –ü—Ä–∞–∫—Ç–∏–∫–∞', 
        quiz: '‚ùì –¢–µ—Å—Ç',
        image: 'üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'
      };
      return titles[step.type] || 'üìå –®–∞–≥';
    },

    getStepComponent(type) {
      const components = {
        explanation: 'step-text', 
        example: 'step-text', 
        reading: 'step-text',
        text: 'step-text',
        video: 'step-video', 
        pdf: 'step-pdf', 
        practice: 'step-practice', 
        quiz: 'step-quiz',
        image: 'step-text'
      };
      return components[type] || 'step-text';
    }
  },

  // === Step Components ===
  components: {
    'step-text': {
      props: ['step'],
      template: `
        <div class="step-text">
          <div class="text-content" v-html="formattedContent"></div>
          <div v-if="hasImages" class="step-images">
            <div v-for="image in step.data.images || step.images || []" :key="image.id" class="step-image">
              <img :src="image.url" :alt="image.alt" :title="image.caption" />
              <p v-if="image.caption" class="image-caption">{{ image.caption }}</p>
            </div>
          </div>
        </div>
      `,
      computed: {
        formattedContent() {
          // ‚úÖ FIXED: Better content extraction and formatting
          let content = '';
          
          // Try multiple sources for content
          if (this.step.data?.content) {
            content = this.step.data.content;
          } else if (this.step.content) {
            content = this.step.content;
          } else if (this.step.text) {
            content = this.step.text;
          } else if (this.step.description) {
            content = this.step.description;
          } else if (this.step.data?.text) {
            content = this.step.data.text;
          } else if (this.step.data?.description) {
            content = this.step.data.description;
          } else {
            content = '–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
          }
          
          // Convert string content to HTML
          if (typeof content === 'string') {
            // Handle different line break formats
            content = content
              .replace(/\r\n/g, '\n')
              .replace(/\r/g, '\n')
              .replace(/\n\n/g, '</p><p>')
              .replace(/\n/g, '<br>')
              .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
              .replace(/\*(.*?)\*/g, '<em>$1</em>');
              
            // Wrap in paragraphs if not already HTML
            if (!content.includes('<p>') && !content.includes('<div>') && content.length > 0) {
              content = '<p>' + content + '</p>';
            }
          }
          
          console.log('üìù Formatted content length:', content.length);
          return content || '<p>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
        },
        hasImages() {
          const images = this.step.data?.images || this.step.images || [];
          return Array.isArray(images) && images.length > 0;
        }
      }
    },

    'step-video': {
      props: ['step'],
      template: `
        <div class="step-video">
          <div class="video-wrapper">
            <div v-if="isYouTube" class="video-embed">
              <iframe 
                :src="embedUrl"
                frameborder="0"
                allowfullscreen
                class="video-iframe"
                title="Video content"
              ></iframe>
            </div>
            <video 
              v-else-if="isDirectVideo"
              controls
              class="video-element"
              :poster="step.data?.thumbnail"
            >
              <source :src="videoUrl" type="video/mp4">
              <source :src="videoUrl" type="video/webm">
              <p>–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.</p>
            </video>
            <div v-else class="video-placeholder">
              <div class="placeholder-icon">üé•</div>
              <p>–í–∏–¥–µ–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</p>
              <small v-if="videoUrl">URL: {{ videoUrl }}</small>
            </div>
          </div>
          <div v-if="description" class="video-description">
            <div v-html="formattedDescription"></div>
          </div>
        </div>
      `,
      computed: {
        videoUrl() {
          return this.step.data?.url || this.step.videoUrl || this.step.video || this.step.url || '';
        },
        description() {
          return this.step.data?.description || this.step.description || this.step.content || '';
        },
        formattedDescription() {
          return this.description.replace(/\n/g, '<br>');
        },
        isYouTube() {
          return this.videoUrl.includes('youtube.com') || this.videoUrl.includes('youtu.be');
        },
        isDirectVideo() {
          return /\.(mp4|webm|ogg)$/i.test(this.videoUrl) || this.videoUrl.includes('blob:');
        },
        embedUrl() {
          if (this.videoUrl.includes('youtube.com/watch')) {
            const videoId = this.videoUrl.split('v=')[1]?.split('&')[0];
            return videoId ? `https://www.youtube.com/embed/${videoId}` : '';
          }
          if (this.videoUrl.includes('youtu.be/')) {
            const videoId = this.videoUrl.split('youtu.be/')[1]?.split('?')[0];
            return videoId ? `https://www.youtube.com/embed/${videoId}` : '';
          }
          return this.videoUrl;
        }
      }
    },

    'step-pdf': {
      props: ['step'],
      emits: ['pdf-fullscreen'],
      template: `
        <div class="step-pdf">
          <div class="pdf-header">
            <h3>üìÑ PDF –ú–∞—Ç–µ—Ä–∏–∞–ª</h3>
            <div v-if="description" v-html="formattedDescription"></div>
          </div>
          
          <div class="pdf-viewer">
            <iframe 
              v-if="pdfUrl"
              :src="pdfUrl" 
              class="pdf-iframe"
              title="PDF Document"
            ></iframe>
            <div v-else class="pdf-placeholder">
              <div class="placeholder-icon">üìÑ</div>
              <p>PDF —Ñ–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</p>
            </div>
          </div>

          <div class="pdf-actions" v-if="pdfUrl">
            <a 
              :href="pdfUrl" 
              target="_blank"
              download
              class="action-btn action-btn--secondary"
            >
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7,10 12,15 17,10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
              –°–∫–∞—á–∞—Ç—å
            </a>
            <button 
              @click="$emit('pdf-fullscreen', pdfUrl)"
              class="action-btn action-btn--secondary"
            >
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15,3 21,3 21,9"></polyline>
                <polyline points="9,21 3,21 3,15"></polyline>
                <line x1="21" y1="3" x2="14" y2="10"></line>
                <line x1="3" y1="21" x2="10" y2="14"></line>
              </svg>
              –ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω
            </button>
          </div>
        </div>
      `,
      computed: {
        pdfUrl() {
          return this.step.data?.url || this.step.pdfUrl || this.step.pdf || this.step.url;
        },
        description() {
          return this.step.data?.description || this.step.description || this.step.content;
        },
        formattedDescription() {
          return this.description ? this.description.replace(/\n/g, '<br>') : '';
        }
      }
    },

    'step-practice': {
      props: ['step'],
      template: `
        <div class="step-practice">
          <div class="practice-header">
            <h3>üéØ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ</h3>
            <div v-if="instructions" v-html="formattedInstructions"></div>
          </div>

          <div v-if="hasFiles" class="practice-files">
            <h4>–§–∞–π–ª—ã –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:</h4>
            <div class="file-grid">
              <a 
                v-for="(file, index) in files"
                :key="index"
                :href="file.url"
                class="file-card"
                target="_blank"
                download
              >
                <div class="file-icon">{{ getFileIcon(file.type) }}</div>
                <span class="file-name">{{ file.name }}</span>
                <div class="download-icon">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7,10 12,15 17,10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                </div>
              </a>
            </div>
          </div>

          <div v-else class="no-files">
            <p>–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ —Å–æ–≥–ª–∞—Å–Ω–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –≤—ã—à–µ</p>
          </div>
        </div>
      `,
      computed: {
        instructions() {
          return this.step.data?.instructions || this.step.instructions || this.step.content || this.step.description;
        },
        formattedInstructions() {
          return this.instructions ? this.instructions.replace(/\n/g, '<br>') : '';
        },
        files() {
          return this.step.data?.files || this.step.files || [];
        },
        hasFiles() {
          return this.files.length > 0;
        }
      },
      methods: {
        getFileIcon(type) {
          const icons = {
            pdf: 'üìÑ', doc: 'üìù', docx: 'üìù', txt: 'üìù',
            zip: 'üì¶', rar: 'üì¶', '7z': 'üì¶',
            jpg: 'üñºÔ∏è', jpeg: 'üñºÔ∏è', png: 'üñºÔ∏è', gif: 'üñºÔ∏è',
            mp4: 'üé•', mov: 'üé•', avi: 'üé•', wmv: 'üé•',
            mp3: 'üéµ', wav: 'üéµ', flac: 'üéµ'
          };
          return icons[type?.toLowerCase()] || 'üìé';
        }
      }
    },

    'step-quiz': {
      props: ['step', 'stepIndex'],
      emits: ['quiz-answer'],
      data() {
        return {
          selectedQuestions: new Map()
        }
      },
      template: `
        <div class="step-quiz">
          <div v-if="quizData && quizData.length > 0">
            <div v-for="(quiz, quizIndex) in quizData" :key="quizIndex" class="quiz-item">
              <div class="quiz-header">
                <h3>‚ùì {{ quiz.question || '–í–æ–ø—Ä–æ—Å –Ω–µ —É–∫–∞–∑–∞–Ω' }}</h3>
              </div>
              
              <div v-if="quiz.options && quiz.options.length > 0" class="quiz-options">
                <button
                  v-for="(option, index) in quiz.options"
                  :key="index"
                  @click="selectAnswer(quizIndex, index, option)"
                  :disabled="isQuizAnswered(quizIndex)"
                  :class="getOptionClass(quizIndex, index, option)"
                  class="quiz-option"
                >
                  <span class="option-text">{{ getOptionText(option) }}</span>
                  <div v-if="isQuizAnswered(quizIndex)" class="option-indicator">
                    <svg v-if="isCorrectOption(option)" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="20,6 9,17 4,12"></polyline>
                    </svg>
                    <svg v-else-if="getSelectedAnswer(quizIndex) === index" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </div>
                </button>
              </div>
              
              <div v-if="isQuizAnswered(quizIndex) && quiz.explanation" class="quiz-explanation">
                <div class="explanation-header">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M9,9h6v6H9z"></path>
                  </svg>
                  –û–±—ä—è—Å–Ω–µ–Ω–∏–µ
                </div>
                <div v-html="formattedExplanation(quiz.explanation)"></div>
              </div>
            </div>
          </div>
          
          <div v-else class="no-quiz">
            <div class="placeholder-icon">‚ùì</div>
            <p>–¢–µ—Å—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</p>
            <small>–î–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã</small>
          </div>
        </div>
      `,
      computed: {
        quizData() {
          const stepData = this.step.data;
          if (Array.isArray(stepData) && stepData.length > 0) {
            return stepData.filter(quiz => quiz && (quiz.question || quiz.text));
          }
          if (stepData && Array.isArray(stepData.questions)) {
            return stepData.questions.filter(quiz => quiz && (quiz.question || quiz.text));
          }
          if (stepData && (stepData.question || stepData.text)) {
            return [{
              question: stepData.question || stepData.text,
              options: stepData.options || [],
              explanation: stepData.explanation || '',
              correctAnswer: stepData.correctAnswer
            }];
          }
          if (Array.isArray(this.step.quizzes)) {
            return this.step.quizzes.filter(quiz => quiz && (quiz.question || quiz.text));
          }
          if (Array.isArray(this.step.data)) {
            return this.step.data.map(quiz => ({
              ...quiz,
              question: quiz.question || quiz.text || '',
              images: this.processImages(quiz.images || [])
            }));
          }
          return [];
        }
      },
      methods: {
        selectAnswer(quizIndex, optionIndex, option) {
          if (this.isQuizAnswered(quizIndex)) return;
          this.selectedQuestions.set(quizIndex, optionIndex);
          const isCorrect = this.isCorrectOption(option);
          this.$emit('quiz-answer', this.stepIndex, optionIndex, isCorrect);
          this.$forceUpdate();
        },
        getOptionText(option) {
          if (typeof option === 'string') return option;
          return option.text || option.label || option.value || '–û–ø—Ü–∏—è';
        },
        isCorrectOption(option) {
          if (typeof option === 'object') {
            return Boolean(option.correct || option.isCorrect);
          }
          return false;
        },
        isQuizAnswered(quizIndex) {
          return this.selectedQuestions.has(quizIndex);
        },
        getSelectedAnswer(quizIndex) {
          return this.selectedQuestions.get(quizIndex);
        },
        getOptionClass(quizIndex, optionIndex, option) {
          const selectedAnswer = this.getSelectedAnswer(quizIndex);
          const isAnswered = this.isQuizAnswered(quizIndex);
          if (!isAnswered) {
            return selectedAnswer === optionIndex ? 'selected' : '';
          }
          if (this.isCorrectOption(option)) {
            return 'correct';
          }
          if (selectedAnswer === optionIndex && !this.isCorrectOption(option)) {
            return 'incorrect';
          }
          return 'disabled';
        },
        formattedExplanation(explanation) {
          return explanation ? explanation.replace(/\n/g, '<br>') : '';
        }
      }
    }
  }
}
</script>
<style scoped>
/* ===== CLEAN MODERN VARIABLES ===== */
:root {
  --primary-blue: #4f46e5;
  --primary-blue-hover: #4338ca;
  --primary-blue-light: #eef2ff;
  
  --success-green: #10b981;
  --success-green-hover: #059669;
  --success-green-light: #ecfdf5;
  
  --danger-red: #ef4444;
  --warning-orange: #f59e0b;
  
  /* Clean grays */
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-300: #d1d5db;
  --gray-400: #9ca3af;
  --gray-500: #6b7280;
  --gray-600: #4b5563;
  --gray-700: #374151;
  --gray-800: #1f2937;
  --gray-900: #111827;
  
  --white: #ffffff;
  --black: #000000;
  
  /* Consistent spacing */
  --space-1: 0.25rem;
  --space-2: 0.5rem;
  --space-3: 0.75rem;
  --space-4: 1rem;
  --space-5: 1.25rem;
  --space-6: 1.5rem;
  --space-8: 2rem;
  --space-12: 3rem;
  
  /* Border radius */
  --radius-sm: 0.375rem;
  --radius: 0.5rem;
  --radius-md: 0.75rem;
  --radius-lg: 1rem;
  --radius-xl: 1.5rem;
  
  /* Shadows */
  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
  --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
  --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
  
  /* Typography */
  --font-size-xs: 0.75rem;
  --font-size-sm: 0.875rem;
  --font-size-base: 1rem;
  --font-size-lg: 1.125rem;
  --font-size-xl: 1.25rem;
  --font-size-2xl: 1.5rem;
  --font-size-3xl: 1.875rem;
  
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 600;
  --font-weight-bold: 700;
  
  /* Transitions */
  --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ===== MAIN OVERLAY - SOLID DARK BACKGROUND ===== */
.lesson-player-overlay {
  position: fixed;
  inset: 0;
  background: rgba(17, 24, 39, 0.95); /* Solid dark background */
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: var(--space-4);
}

/* ===== MAIN PLAYER CONTAINER ===== */
.lesson-player {
  background: var(--white); /* Solid white background */
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-xl);
  width: 100%;
  max-width: 1200px;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
}

/* ===== HEADER SECTION ===== */
.player-header {
  background: var(--white); /* Solid white */
  border-bottom: 1px solid var(--gray-200);
  padding: var(--space-6) var(--space-8);
  display: flex;
  align-items: flex-start;
  gap: var(--space-6);
  position: relative;
  min-height: 120px;
}

.close-btn {
  position: absolute;
  top: var(--space-4);
  right: var(--space-4);
  background: var(--gray-100);
  border: none;
  border-radius: var(--radius-md);
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--gray-600);
  cursor: pointer;
  transition: var(--transition);
  z-index: 10;
}

.close-btn:hover {
  background: var(--gray-200);
  color: var(--gray-900);
  transform: scale(1.05);
}

.header-content {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  width: 100%;
  padding-right: var(--space-12);
  gap: var(--space-8);
}

.course-info {
  flex: 1;
  min-width: 0;
}

.course-name {
  display: block;
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-semibold);
  color: var(--primary-blue);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: var(--space-2);
  opacity: 0.9;
}

.lesson-title {
  font-size: var(--font-size-2xl);
  font-weight: var(--font-weight-bold);
  color: var(--gray-900);
  margin: 0;
  line-height: 1.2;
  word-wrap: break-word;
}

.progress-section {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: var(--space-3);
  min-width: 200px;
  flex-shrink: 0;
}

.progress-bar {
  width: 200px;
  height: 8px;
  background: var(--gray-200);
  border-radius: var(--radius);
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary-blue), var(--success-green));
  border-radius: var(--radius);
  transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.progress-text {
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  color: var(--gray-600);
  white-space: nowrap;
}

/* ===== MAIN CONTENT AREA ===== */
.player-content {
  flex: 1;
  overflow-y: auto;
  padding: var(--space-8);
  background: var(--gray-50); /* Light gray background for content area */
}

/* ===== LOADING & ERROR STATES ===== */
.loading-state, .error-state, .no-content, .empty-lesson {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  min-height: 400px;
  padding: var(--space-12);
  background: var(--white);
  border-radius: var(--radius-lg);
  margin: var(--space-4) 0;
}

.loading-state h3, .error-state h3, .no-content h3, .empty-lesson h3 {
  font-size: var(--font-size-xl);
  font-weight: var(--font-weight-semibold);
  margin: 0 0 var(--space-3) 0;
  color: var(--gray-800);
}

.loading-state p, .error-state p, .no-content p, .empty-lesson p {
  margin: 0 0 var(--space-6) 0;
  font-size: var(--font-size-base);
  color: var(--gray-600);
  max-width: 400px;
  line-height: 1.6;
}

.error-icon, .empty-icon {
  font-size: 4rem;
  margin-bottom: var(--space-6);
  opacity: 0.7;
}

.retry-btn, .back-btn {
  padding: var(--space-3) var(--space-6);
  background: var(--primary-blue);
  color: var(--white);
  border: none;
  border-radius: var(--radius-md);
  font-weight: var(--font-weight-semibold);
  font-size: var(--font-size-sm);
  cursor: pointer;
  transition: var(--transition);
  min-width: 120px;
}

.retry-btn:hover, .back-btn:hover {
  background: var(--primary-blue-hover);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

/* Spinner */
.spinner {
  width: 48px;
  height: 48px;
  border: 4px solid var(--gray-200);
  border-top: 4px solid var(--primary-blue);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: var(--space-6);
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ===== LESSON CONTENT ===== */
.lesson-content {
  display: flex;
  flex-direction: column;
  gap: var(--space-6);
}

.step-container {
  background: var(--white);
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-lg);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
  transition: var(--transition);
}

.step-container:hover {
  box-shadow: var(--shadow-md);
  border-color: var(--gray-300);
}

.step-header {
  background: var(--gray-50);
  padding: var(--space-5) var(--space-6);
  border-bottom: 1px solid var(--gray-200);
  display: flex;
  align-items: center;
  gap: var(--space-4);
}

.step-number {
  width: 32px;
  height: 32px;
  background: var(--primary-blue);
  color: var(--white);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: var(--font-weight-bold);
  font-size: var(--font-size-sm);
  flex-shrink: 0;
  box-shadow: var(--shadow-sm);
}

.step-title {
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-semibold);
  color: var(--gray-900);
  margin: 0;
  line-height: 1.3;
}

.step-body {
  padding: var(--space-8);
  background: var(--white);
}

/* ===== FOOTER NAVIGATION ===== */
.player-footer {
  background: var(--white);
  border-top: 1px solid var(--gray-200);
  padding: var(--space-6) var(--space-8);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: var(--space-4);
  box-shadow: 0 -1px 3px 0 rgb(0 0 0 / 0.05);
}

.nav-btn {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  padding: var(--space-3) var(--space-5);
  border: none;
  border-radius: var(--radius-md);
  font-weight: var(--font-weight-semibold);
  font-size: var(--font-size-sm);
  cursor: pointer;
  transition: var(--transition);
  min-width: 140px;
  justify-content: center;
  height: 44px;
}

.nav-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

.nav-btn--primary {
  background: var(--primary-blue);
  color: var(--white);
  box-shadow: var(--shadow-sm);
}

.nav-btn--primary:hover:not(:disabled) {
  background: var(--primary-blue-hover);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.nav-btn--secondary {
  background: var(--white);
  color: var(--gray-700);
  border: 1px solid var(--gray-300);
  box-shadow: var(--shadow-sm);
}

.nav-btn--secondary:hover:not(:disabled) {
  background: var(--gray-50);
  border-color: var(--gray-400);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.nav-btn--success {
  background: var(--success-green);
  color: var(--white);
  box-shadow: var(--shadow-sm);
}

.nav-btn--success:hover:not(:disabled) {
  background: var(--success-green-hover);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.lesson-counter {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  padding: var(--space-3) var(--space-5);
  background: var(--gray-100);
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-md);
  font-weight: var(--font-weight-semibold);
  color: var(--gray-700);
  font-size: var(--font-size-sm);
}

.current-lesson {
  color: var(--primary-blue);
  font-weight: var(--font-weight-bold);
}

.divider {
  color: var(--gray-400);
  margin: 0 var(--space-1);
}

/* ===== STEP COMPONENT STYLES ===== */

/* Text Step */
.step-text {
  line-height: 1.7;
}

.text-content {
  font-size: var(--font-size-base);
  color: var(--gray-700);
  line-height: 1.7;
}

.text-content p {
  margin: 0 0 var(--space-4) 0;
}

.text-content p:last-child {
  margin-bottom: 0;
}

.text-content ul, .text-content ol {
  margin: var(--space-4) 0;
  padding-left: var(--space-6);
}

.text-content li {
  margin-bottom: var(--space-2);
  line-height: 1.6;
}

.step-images {
  margin-top: var(--space-6);
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: var(--space-4);
}

.step-image {
  background: var(--white);
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-md);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
}

.step-image img {
  width: 100%;
  height: auto;
  display: block;
}

.image-caption {
  padding: var(--space-3);
  font-size: var(--font-size-sm);
  color: var(--gray-600);
  font-style: italic;
  margin: 0;
  background: var(--gray-50);
  border-top: 1px solid var(--gray-200);
}

/* Video Step */
.step-video {
  display: flex;
  flex-direction: column;
  gap: var(--space-6);
}

.video-wrapper {
  position: relative;
  width: 100%;
  max-width: 800px;
  margin: 0 auto;
  border-radius: var(--radius-lg);
  overflow: hidden;
  box-shadow: var(--shadow-lg);
}

.video-embed {
  position: relative;
  width: 100%;
  height: 0;
  padding-bottom: 56.25%; /* 16:9 */
  background: var(--gray-900);
}

.video-iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border: none;
}

.video-element {
  width: 100%;
  height: auto;
  max-height: 500px;
  display: block;
}

.video-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 300px;
  background: var(--gray-100);
  color: var(--gray-500);
  border-radius: var(--radius-md);
}

.placeholder-icon {
  font-size: 4rem;
  margin-bottom: var(--space-4);
  opacity: 0.6;
}

.video-description {
  text-align: center;
  font-style: italic;
  color: var(--gray-600);
  font-size: var(--font-size-sm);
  margin: 0;
  padding: 0 var(--space-4);
}

/* PDF Step */
.step-pdf {
  display: flex;
  flex-direction: column;
  gap: var(--space-6);
}

.pdf-header h3 {
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-semibold);
  color: var(--gray-900);
  margin: 0 0 var(--space-2) 0;
}

.pdf-header p {
  color: var(--gray-600);
  margin: 0;
  line-height: 1.6;
}

.pdf-viewer {
  position: relative;
  width: 100%;
  height: 600px;
  border-radius: var(--radius-lg);
  overflow: hidden;
  box-shadow: var(--shadow-lg);
  background: var(--white);
  border: 1px solid var(--gray-200);
}

.pdf-iframe {
  width: 100%;
  height: 100%;
  border: none;
}

.pdf-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--gray-500);
  background: var(--gray-50);
}

.pdf-actions {
  display: flex;
  gap: var(--space-4);
  justify-content: center;
  flex-wrap: wrap;
}

.action-btn {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  padding: var(--space-3) var(--space-4);
  border: none;
  border-radius: var(--radius-md);
  font-weight: var(--font-weight-medium);
  font-size: var(--font-size-sm);
  text-decoration: none;
  cursor: pointer;
  transition: var(--transition);
  min-width: 120px;
  justify-content: center;
  height: 40px;
}

.action-btn--secondary {
  background: var(--gray-100);
  color: var(--gray-700);
  border: 1px solid var(--gray-300);
}

.action-btn--secondary:hover {
  background: var(--gray-200);
  border-color: var(--gray-400);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

/* Practice Step */
.step-practice {
  display: flex;
  flex-direction: column;
  gap: var(--space-6);
}

.practice-header {
  padding: var(--space-6);
  background: var(--primary-blue-light);
  border-radius: var(--radius-md);
  border: 1px solid rgba(79, 70, 229, 0.2);
}

.practice-header h3 {
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-semibold);
  color: var(--gray-900);
  margin: 0 0 var(--space-3) 0;
}

.practice-header p {
  color: var(--gray-700);
  margin: 0;
  line-height: 1.6;
}

.practice-files h4 {
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-semibold);
  color: var(--gray-900);
  margin: 0 0 var(--space-4) 0;
}

.file-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: var(--space-4);
}

.file-card {
  display: flex;
  align-items: center;
  gap: var(--space-4);
  padding: var(--space-4);
  background: var(--white);
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-md);
  text-decoration: none;
  color: var(--gray-700);
  transition: var(--transition);
  box-shadow: var(--shadow-sm);
}

.file-card:hover {
  background: var(--gray-50);
  border-color: var(--primary-blue);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.file-icon {
  font-size: var(--font-size-2xl);
  flex-shrink: 0;
}

.file-name {
  flex: 1;
  font-weight: var(--font-weight-medium);
  font-size: var(--font-size-sm);
  line-height: 1.4;
}

.download-icon {
  color: var(--gray-400);
  flex-shrink: 0;
  transition: var(--transition);
}

.file-card:hover .download-icon {
  color: var(--primary-blue);
  transform: translateY(-1px);
}

.no-files {
  text-align: center;
  color: var(--gray-500);
  font-style: italic;
  padding: var(--space-8);
  background: var(--gray-50);
  border-radius: var(--radius-md);
  border: 1px dashed var(--gray-300);
}

.no-files p {
  margin: 0;
  font-size: var(--font-size-base);
}

/* Quiz Step */
.step-quiz {
  display: flex;
  flex-direction: column;
  gap: var(--space-6);
}

.quiz-item {
  background: var(--white);
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-lg);
  padding: var(--space-6);
  box-shadow: var(--shadow-sm);
}

.quiz-item + .quiz-item {
  margin-top: var(--space-6);
}

.quiz-header h3 {
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-semibold);
  color: var(--gray-900);
  margin: 0 0 var(--space-5) 0;
  line-height: 1.4;
}

.quiz-options {
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
}

.quiz-option {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-4);
  background: var(--white);
  border: 2px solid var(--gray-200);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: var(--transition);
  text-align: left;
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-medium);
  color: var(--gray-700);
  width: 100%;
  box-shadow: var(--shadow-sm);
}

.quiz-option:hover:not(:disabled) {
  background: var(--gray-50);
  border-color: var(--primary-blue);
  transform: translateX(4px);
  box-shadow: var(--shadow-md);
}

.quiz-option:disabled {
  cursor: not-allowed;
}

.quiz-option.selected {
  border-color: var(--primary-blue);
  background: var(--primary-blue-light);
  box-shadow: var(--shadow-md);
}

.quiz-option.correct {
  border-color: var(--success-green);
  background: var(--success-green-light);
  color: var(--success-green-hover);
  box-shadow: var(--shadow-md);
}

.quiz-option.incorrect {
  border-color: var(--danger-red);
  background: rgba(239, 68, 68, 0.1);
  color: var(--danger-red);
  box-shadow: var(--shadow-md);
}

.quiz-option.disabled {
  opacity: 0.7;
}

.option-text {
  flex: 1;
  line-height: 1.5;
}

.option-indicator {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  flex-shrink: 0;
  border-radius: 50%;
  margin-left: var(--space-3);
}

.quiz-option.correct .option-indicator {
  background: var(--success-green);
  color: var(--white);
}

.quiz-option.incorrect .option-indicator {
  background: var(--danger-red);
  color: var(--white);
}

.quiz-explanation {
  padding: var(--space-5);
  background: var(--gray-50);
  border-radius: var(--radius-md);
  border-left: 4px solid var(--primary-blue);
  margin-top: var(--space-5);
  box-shadow: var(--shadow-sm);
}

.explanation-header {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  font-weight: var(--font-weight-semibold);
  color: var(--gray-900);
  margin-bottom: var(--space-3);
  font-size: var(--font-size-sm);
}

.quiz-explanation p {
  margin: 0;
  color: var(--gray-700);
  line-height: 1.6;
  font-size: var(--font-size-base);
}

.no-quiz {
  text-align: center;
  color: var(--gray-500);
  padding: var(--space-8);
  background: var(--gray-50);
  border-radius: var(--radius-md);
  border: 1px dashed var(--gray-300);
}

.no-quiz .placeholder-icon {
  font-size: 3rem;
  margin-bottom: var(--space-4);
  opacity: 0.6;
}

.no-quiz p {
  margin: 0 0 var(--space-2) 0;
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-medium);
}

.no-quiz small {
  font-size: var(--font-size-sm);
  color: var(--gray-400);
}

/* PDF Fullscreen Modal */
.pdf-modal {
  position: fixed;
  inset: 0;
  background: rgba(17, 24, 39, 0.95);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  padding: var(--space-4);
}

.pdf-container {
  position: relative;
  width: 100%;
  height: 100%;
  max-width: 1400px;
  max-height: 95vh;
  background: var(--white);
  border-radius: var(--radius-lg);
  overflow: hidden;
  box-shadow: var(--shadow-xl);
}

.pdf-close-btn {
  position: absolute;
  top: var(--space-4);
  right: var(--space-4);
  z-index: 10;
  background: var(--white);
  border: none;
  border-radius: 50%;
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--gray-600);
  cursor: pointer;
  transition: var(--transition);
  box-shadow: var(--shadow-md);
}

.pdf-close-btn:hover {
  background: var(--gray-100);
  color: var(--gray-900);
  transform: scale(1.05);
}

.pdf-frame {
  width: 100%;
  height: 100%;
  border: none;
}

/* ===== RESPONSIVE DESIGN ===== */
@media (max-width: 1200px) {
  .lesson-player {
    max-width: 95vw;
  }
  
  .header-content {
    gap: var(--space-6);
  }
  
  .progress-section {
    min-width: 180px;
  }
  
  .progress-bar {
    width: 180px;
  }
}

@media (max-width: 768px) {
  .lesson-player-overlay {
    padding: 0;
  }
  
  .lesson-player {
    width: 100%;
    height: 100vh;
    max-height: 100vh;
    border-radius: 0;
  }
  
  .player-header {
    padding: var(--space-4);
    flex-direction: column;
    align-items: stretch;
    gap: var(--space-4);
    min-height: auto;
  }
  
  .close-btn {
    position: absolute;
    top: var(--space-3);
    right: var(--space-3);
    width: 36px;
    height: 36px;
  }
  
  .header-content {
    flex-direction: column;
    align-items: stretch;
    gap: var(--space-4);
    padding-right: 0;
    padding-top: var(--space-4);
  }
  
  .course-info {
    text-align: center;
  }
  
  .lesson-title {
    font-size: var(--font-size-xl);
  }
  
  .progress-section {
    align-items: stretch;
    min-width: auto;
  }
  
  .progress-bar {
    width: 100%;
  }
  
  .progress-text {
    text-align: center;
  }
  
  .player-content {
    padding: var(--space-4);
  }
  
  .step-body {
    padding: var(--space-4);
  }
  
  .step-header {
    padding: var(--space-4);
  }
  
  .player-footer {
    padding: var(--space-4);
    flex-direction: column;
    gap: var(--space-4);
  }
  
  .nav-btn {
    width: 100%;
    min-width: auto;
  }
  
  .lesson-counter {
    order: -1;
    justify-content: center;
  }
  
  .pdf-viewer {
    height: 400px;
  }
  
  .video-embed {
    padding-bottom: 75%; /* 4:3 on mobile */
  }
  
  .file-grid {
    grid-template-columns: 1fr;
  }
  
  .step-images {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 480px) {
  .player-header {
    padding: var(--space-3);
  }
  
  .step-header {
    padding: var(--space-3);
    gap: var(--space-3);
  }
  
  .step-number {
    width: 28px;
    height: 28px;
    font-size: var(--font-size-xs);
  }
  
  .step-title {
    font-size: var(--font-size-base);
  }
  
  .step-body {
    padding: var(--space-3);
  }
  
  .pdf-viewer {
    height: 300px;
  }
  
  .quiz-option {
    padding: var(--space-3);
    font-size: var(--font-size-sm);
  }
  
  .file-card {
    padding: var(--space-3);
    gap: var(--space-3);
  }
  
  .practice-header {
    padding: var(--space-4);
  }
  
  .quiz-item {
    padding: var(--space-4);
  }
  
  .loading-state, .error-state, .no-content, .empty-lesson {
    padding: var(--space-6);
    min-height: 300px;
  }
  
  .lesson-title {
    font-size: var(--font-size-lg);
  }
  
  .course-name {
    font-size: var(--font-size-xs);
  }
  
  .pdf-modal {
    padding: var(--space-2);
  }
  
  .pdf-close-btn {
    width: 40px;
    height: 40px;
    top: var(--space-2);
    right: var(--space-2);
  }
}

/* ===== ACCESSIBILITY & FOCUS STYLES ===== */
.close-btn:focus-visible,
.nav-btn:focus-visible,
.quiz-option:focus-visible,
.file-card:focus-visible,
.action-btn:focus-visible,
.retry-btn:focus-visible,
.back-btn:focus-visible,
.pdf-close-btn:focus-visible {
  outline: 2px solid var(--primary-blue);
  outline-offset: 2px;
}

/* ===== ANIMATIONS ===== */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.step-container {
  animation: fadeIn 0.3s ease-out;
}

.lesson-content .step-container:nth-child(1) { animation-delay: 0.1s; }
.lesson-content .step-container:nth-child(2) { animation-delay: 0.2s; }
.lesson-content .step-container:nth-child(3) { animation-delay: 0.3s; }
.lesson-content .step-container:nth-child(4) { animation-delay: 0.4s; }
.lesson-content .step-container:nth-child(5) { animation-delay: 0.5s; }

.quiz-option {
  animation: slideIn 0.2s ease-out;
}

.quiz-options .quiz-option:nth-child(1) { animation-delay: 0.1s; }
.quiz-options .quiz-option:nth-child(2) { animation-delay: 0.2s; }
.quiz-options .quiz-option:nth-child(3) { animation-delay: 0.3s; }
.quiz-options .quiz-option:nth-child(4) { animation-delay: 0.4s; }

/* ===== HIGH CONTRAST MODE SUPPORT ===== */
@media (prefers-contrast: high) {
  :root {
    --gray-200: #d1d5db;
    --gray-300: #9ca3af;
    --gray-400: #6b7280;
  }
  
  .step-container,
  .quiz-item,
  .file-card,
  .practice-header {
    border-width: 2px;
  }
}

/* ===== REDUCED MOTION SUPPORT ===== */
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
  
  .step-container,
  .quiz-option {
    animation: none;
  }
}

/* ===== PRINT STYLES ===== */
@media print {
  .lesson-player-overlay {
    position: static;
    background: none;
    padding: 0;
  }
  
  .lesson-player {
    box-shadow: none;
    border: 1px solid var(--gray-300);
    max-height: none;
  }
  
  .close-btn,
  .player-footer {
    display: none;
  }
  
  .player-content {
    overflow: visible;
  }
  
  .step-container {
    break-inside: avoid;
    margin-bottom: var(--space-6);
  }
  
  .video-wrapper,
  .pdf-viewer {
    display: none;
  }
  
  .video-description {
    display: block;
    text-align: left;
    font-style: normal;
    padding: var(--space-4);
    border: 1px solid var(--gray-300);
    border-radius: var(--radius);
    background: var(--gray-50);
  }
  
  .video-description::before {
    content: "–í–∏–¥–µ–æ: ";
    font-weight: bold;
  }
}
</style>